<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>素数フラッシュ判定ゲーム ～3秒で決める～</title>
<script src="https://formsubmit.co/formsubmit.js"></script>
<style>
  body { font-family: sans-serif; text-align: center; padding: 50px; background: #111; color: #fff; }
  h1 { color: #0f8; }
  #number { font-size: 5em; font-weight: bold; margin: 60px; color: #0ff; height: 120px; }
  .buttons { margin: 40px; }
  button { font-size: 1.8em; padding: 20px 50px; margin: 15px; border-radius: 15px; border: none; color: white; cursor: pointer; }
  #prime { background: #27ae60; }
  #notprime { background: #c0392b; }
  #timer { font-size: 2em; color: #ff0; }
  #result { font-size: 1.8em; margin: 20px; }
  .hidden { display: none; }
</style>
</head>
<body>
  <h1>素数フラッシュ判定ゲーム</h1>
  <p>3秒以内に判断してください！</p>
  <div id="timer" class="hidden">残り <span id="countdown">3.0</span>秒</div>
  <div id="number">準備中...</div>
  
  <div class="buttons">
    <button id="prime">素数！</button>
    <button id="notprime">素数じゃない！</button>
  </div>
  
  <div id="result"></div>
  <div id="final" class="hidden"></div>

<script>
const TOTAL_QUESTIONS = 10;
let results = [];
let currentQuestion = 0;
let timerInterval = null;

let questionPool = [];
function generateBalancedQuestions() {
  const primes = [];
  const composites = [];

  while (primes.length < 6) {
    let n = randomOddNumber();
    if (isPrime(n) && !primes.includes(n)) primes.push(n);
  }
  while (composites.length < 6) {
    let n = randomOddNumber();
    if (!isPrime(n) && n % 3 !== 0 && n % 7 !== 0 && !composites.includes(n)) {
      composites.push(n);
    }
  }

  const primeCount = 4 + Math.floor(Math.random() * 3); // 4,5,6
  const selectedPrimes = shuffle(primes.slice(0, primeCount));
  const selectedComposites = shuffle(composites.slice(0, 10 - primeCount));

  questionPool = [...selectedPrimes.map(n => ({num: n, isPrime: true})),
                  ...selectedComposites.map(n => ({num: n, isPrime: false}))];
  questionPool = shuffle(questionPool);
}

function randomOddNumber() {
  const min = 1000, max = 999999;
  let num;
  do {
    num = Math.floor(Math.random() * (max - min + 1)) + min;
  } while (num % 2 === 0 || num % 5 === 0);
  return num % 2 === 1 ? num : num + 1;
}

function isPrime(n) {
  if (n <= 1) return false;
  if (n <= 3) return true;
  ;
  if (n % 2 === 0 || n % 3 === 0) return false;
  for (let i = 5; i * i <= n; i += 6) {
    if (n % i === 0 || n % (i + 2) === 0) return false;
  }
  return true;
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function startQuestion() {
  if (currentQuestion >= TOTAL_QUESTIONS) {
    endGame();
    return;
  }
  currentQuestion++;
  const q = questionPool[currentQuestion - 1];
  
  document.getElementById("number").textContent = q.num;
  document.getElementById("result").textContent = `第 ${currentQuestion} 問 / 全 ${TOTAL_QUESTIONS} 問`;
  
  let timeLeft = 3.0;   // ← ここだけ3秒に変更
  document.getElementById("countdown").textContent = "3.0";
  document.getElementById("timer").classList.remove("hidden");
  
  timerInterval = setInterval(() => {
    timeLeft -= 0.1;
    document.getElementById("countdown").textContent = timeLeft.toFixed(1);
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      timerInterval = null;
      document.getElementById("timer").classList.add("hidden");
      document.getElementById("number").textContent = "時間切れ";
      
      results.push({
        question: currentQuestion,
        number: q.num,
        isPrime: q.isPrime,
        userAnswer: null,
        correct: null
      });
      
      setTimeout(startQuestion, 800);
    }
  }, 100);

  const answer = (userThinksPrime) => {
    if (!timerInterval) return;
    clearInterval(timerInterval);
    timerInterval = null;
    document.getElementById("timer").classList.add("hidden");
    
    const correct = (userThinksPrime === q.isPrime);
    results.push({
      question: currentQuestion,
      number: q.num,
      isPrime: q.isPrime,
      userAnswer: userThinksPrime,
      correct: correct
    });
    
    document.getElementById("number").textContent = correct ? "正解！" : "不正解…";
    setTimeout(startQuestion, 800);
  };

  document.getElementById("prime").onclick = () => answer(true);
  document.getElementById("notprime").onclick = () => answer(false);
}

function endGame() {
  document.querySelector(".buttons").classList.add("hidden");
  document.getElementById("final").classList.remove("hidden");

  let table = "問題,数字,正解,あなたの回答,正誤\n";
  let answered = 0, correct = 0;
  results.forEach(r => {
    const actual = r.isPrime ? "素数" : "合成数";
    const ans = r.userAnswer === null ? "無回答" : (r.userAnswer ? "素数" : "合成数");
    const mark = r.correct === null ? "-" : (r.correct ? "○" : "×");
    table += `${r.question},${r.number},${actual},${ans},${mark}\n`;
    if (r.userAnswer !== null) answered++;
    if (r.correct) correct++;
  });
  table += `\n回答数,${answered}/10\n正答数,${correct}/${answered}\n`;
  table += `終了時刻,${new Date().toLocaleString('ja-JP')}\n`;
  table += `ブラウザ,${navigator.userAgent}\n`;

  const formData = new FormData();
  formData.append("3秒素数判定結果", table);
  formData.append("_subject", "3秒素数ゲーム結果 " + new Date().toISOString().slice(0,19).replace("T"," "));
  formData.append("_captcha", "false");

  fetch("https://formsubmit.co/sakirubymiku@gmail.com", {
    method: "POST",
    body: formData
  });

  document.getElementById("final").innerHTML = `
    <h2>10問終了！</h2>
    <p style="font-size:2em;">回答数: ${answered}/10<br>正答数: <b>${correct}/${answered}</b></p>
    <p style="color:#0f0;font-size:2em;">結果は自動送信されました！</p>
  `;
}

generateBalancedQuestions();
window.onload = () => setTimeout(startQuestion, 1500);
</script>
</body>
</html>